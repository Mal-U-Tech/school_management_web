<ng-container *ngIf="class$ | async as class">
  <app-content>
    <div class="tw-flex tw-items-center">
      <h1 class="title">{{ class.name }}</h1>

      <button mat-icon-button [matMenuTriggerFor]="general" class="tw-ml-auto">
        <mat-icon color="primary">more_vert</mat-icon>
      </button>
    </div>

    <hr class="tw-mb-6" />

    <div class="teachers">
      <h2>Teachers</h2>
      <app-panel>
        <div class="tw-m-6">
          <div class="tw-flex tw-items-center hint">
            <div class="tw-flex tw-items-center">
              <mat-icon color="primary" class="tw-mr-1">info_outline</mat-icon>
              <p class="tw-m-0" class="primary">Update the teachers ({{ class.users?.length ?? 0}}) associated with <b>{{ class.name }}</b></p>
            </div>

            <button mat-flat-button color="primary" class="tw-ml-auto" [disabled]="(class.users?.length ?? 0) < 1" (click)="updateteachers(class)">Update</button>
          </div>

          <table mat-table [dataSource]="class?.users ?? []">
            <ng-container matColumnDef="options">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let teacher">
                <button mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon color="primary">more_horizontal</mat-icon>
                </button>

                <mat-menu #menu>
                  <button mat-menu-item (click)="removeteacher(class, teacher)" class="warn"><mat-icon color="warn">delete</mat-icon> Remove</button>
                </mat-menu>
              </td>
            </ng-container>

            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Name</th>
              <td mat-cell *matCellDef="let teacher" class="tw-capitalize">
                {{ teacher?.firstname ?? '' }} {{ teacher?.lastname ?? '' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="contact">
              <th mat-header-cell *matHeaderCellDef>Contact Information</th>
              <td mat-cell *matCellDef="let teacher">
                <a [href]="'mailto:' + teacher?.email">{{ teacher?.email }}</a>
                <ng-container *ngIf="teacher?.mobile">/{{ teacher?.mobile }}</ng-container>
              </td>
            </ng-container>

            <ng-container matColumnDef="remove">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let teacher">
                <button mat-icon-button [matTooltip]="getteachertooltip(class, teacher)" (click)="removeteacher(class, teacher)">
                  <mat-icon color="warn">delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr *matNoDataRow>
              <td class="mat-cell" [attr.colspan]="subject_columns.length">
                <div class="tw-flex tw-flex-col tw-items-center tw-mt-4 nosubjects">
                  <p>{{ class.name }} has no subjects associated.</p>

                  <button mat-stroked-button color="primary" (click)="updatesubjects(class)">Add Subjects</button>
                </div>
              </td>
            </tr>

            <tr mat-header-row *matHeaderRowDef="teacher_columns"></tr>
            <tr mat-row *matRowDef="let row; columns: teacher_columns"></tr>
          </table>
        </div>
      </app-panel>
    </div>

    <div class="subjects tw-mt-8">
      <h2>Subjects</h2>
      <app-panel>
        <div class="tw-m-6">

          <div class="tw-flex tw-items-center hint">
            <div class="tw-flex tw-items-center">
              <mat-icon color="primary" class="tw-mr-1">info_outline</mat-icon>
              <p class="tw-m-0" class="primary">Update the subjects ({{ class.subjects?.length ?? 0}}) that are associated to <b>{{ class.name }}</b></p>
            </div>

            <button mat-flat-button color="primary" class="tw-ml-auto" [disabled]="(class.subjects?.length ?? 0) < 1" (click)="updatesubjects(class)">Update</button>
          </div>

          <table mat-table [dataSource]="class?.subjects ?? []">
            <ng-container matColumnDef="options">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let subject">
                <button mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon color="primary">more_horizontal</mat-icon>
                </button>

                <mat-menu #menu>
                  <button mat-menu-item (click)="removesubject(class, subject)" class="warn"><mat-icon color="warn">delete</mat-icon> Remove</button>
                </mat-menu>
              </td>
            </ng-container>

            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Name</th>
              <td mat-cell *matCellDef="let subject" class="tw-capitalize">
                {{ subject.name }}
              </td>
            </ng-container>

            <ng-container matColumnDef="remove">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let subject">
                <button mat-icon-button [matTooltip]="getsubjecttooltip(class, subject)" (click)="removesubject(class, subject)">
                  <mat-icon color="warn">delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr *matNoDataRow>
              <td class="mat-cell" [attr.colspan]="subject_columns.length">
                <div class="tw-flex tw-flex-col tw-items-center tw-mt-4 nosubjects">
                  <p>{{ class.name }} has no subjects associated.</p>

                  <button mat-stroked-button color="primary" (click)="updatesubjects(class)">Add Subjects</button>
                </div>
              </td>
            </tr>

            <tr mat-header-row *matHeaderRowDef="subject_columns"></tr>
            <tr mat-row *matRowDef="let row; columns: subject_columns"></tr>
          </table>
        </div>
      </app-panel>
    </div>

    <div class="students tw-mt-8">
      <h2>Students</h2>
      <app-panel>
        <div class="tw-m-6">
          <div class="tw-flex tw-items-center hint">
            <div class="tw-flex tw-items-center">
              <mat-icon color="primary" class="tw-mr-1">info_outline</mat-icon>
              <p class="tw-m-0" class="primary">Add & Remove students ({{ class.students?.length ?? 0}}) in <b>{{ class.name }}</b></p>
            </div>

            <button mat-flat-button color="primary" class="tw-ml-auto" [disabled]="((school$ | async)?.students?.length ?? 0) < 1" (click)="updatestudents(class)">Update</button>
          </div>

          <table mat-table [dataSource]="context.loading ? [] : (class?.students ?? [])" *ngIf="({ loading: loading$ | async }) as context">
            <ng-container matColumnDef="avatar">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let student">
                <div matRipple class="avatar">
                  <img *ngIf="student.user?.avatar" [src]="student.user?.avatar" />
                  <mat-icon *ngIf="!student.user?.avatar">account_circle</mat-icon>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Full Name</th>
              <td mat-cell *matCellDef="let student" class="tw-capitalize">
                {{ student.user?.firstname?.toLowerCase() ?? '' }}
                {{ student.user?.lastname?.toLowerCase() ?? '' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="contact">
              <th mat-header-cell *matHeaderCellDef>Contact Information</th>
              <td mat-cell *matCellDef="let student">
                <a [href]="'mailto:' + student.user?.email">{{ student.user?.email }}</a>
                <ng-container *ngIf="student.user?.mobile">/{{ student.user?.mobile }}</ng-container>
              </td>
            </ng-container>

            <ng-container matColumnDef="remove">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let student">
                <button mat-icon-button [matTooltip]="getstudenttooltip(class, student)" (click)="removestudent(class, student)">
                  <mat-icon color="warn">delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr *matNoDataRow>
              <td class="mat-cell" [attr.colspan]="subject_columns.length">
                <div class="tw-flex tw-flex-col tw-items-center tw-mt-4 nosubjects" *ngIf="!context.loading">
                  <p>
                  {{ class.name }} has no students associated.
                  @if ((add_student_permission$ | async) === false) {
                    You do not have permission to add new students.
                  }
                  </p>

                  @if (add_student_permission$ | async) {
                    <button mat-stroked-button color="primary" routerLink="../../students" (click)="addstudents()">Add Students</button>
                  }
                </div>

                <app-loader class="loader" *ngIf="context.loading"></app-loader>
              </td>
            </tr>

            <tr mat-header-row *matHeaderRowDef="student_columns"></tr>
            <tr mat-row *matRowDef="let row; columns: student_columns"></tr>
          </table>
        </div>
      </app-panel>
    </div>
  </app-content>

  <mat-menu #general>
    <button mat-menu-item (click)="changename(class)" class="primary"><mat-icon color="primary">edit</mat-icon> Change Name</button>
  </mat-menu>
</ng-container>
